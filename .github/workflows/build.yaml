name: üè≠ Build Dockhand

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      short_sha: ${{ steps.vars.outputs.short_sha }}
      date_tag: ${{ steps.vars.outputs.date_tag }}
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üßÆ Calculate Vars
        id: vars
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          
          echo "Znaleziono hash: $SHORT_SHA"
    
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

  build-amd64:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üèóÔ∏è Build AMD64
        run: |
          TAG=${{ needs.setup.outputs.short_sha }}

          docker build \
            --provenance=false \
            --platform linux/amd64 \
            -t ${{ secrets.REGISTRY_URL }}/${{ secrets.IMAGE_NAME }}:${TAG}-amd64 .
          
          docker push ${{ secrets.REGISTRY_URL }}/${{ secrets.IMAGE_NAME }}:${TAG}-amd64

  # merge-manifest:
  #   needs: [setup, build-amd64]
  #   runs-on: [self-hosted, arm64]
  #   steps:
  #     - name: ü™Ñ Create Manifests
  #       run: |
  #         TAG=${{ needs.setup.outputs.short_sha }}
  #         BASE_IMG=${{ secrets.REGISTRY_URL }}/${{ secrets.IMAGE_NAME }}
          
  #         echo "Sklejam tag: ${TAG}..."
          
  #         # 1. Tworzymy g≈Ç√≥wny manifest z hashem (np. moj-sklep:a1b2c3d)
  #         # To jest ten "bezpieczny", unikalny tag
  #         docker manifest create ${BASE_IMG}:${TAG} \
  #           ${BASE_IMG}:${TAG}-amd64 \
  #           ${BASE_IMG}:${TAG}-arm64
            
  #         # Adnotacje (≈ºeby docker wiedzia≈Ç co jest co)
  #         docker manifest annotate ${BASE_IMG}:${TAG} ${BASE_IMG}:${TAG}-amd64 --os linux --arch amd64
  #         docker manifest annotate ${BASE_IMG}:${TAG} ${BASE_IMG}:${TAG}-arm64 --os linux --arch arm64
          
  #         # Wypychamy unikalny tag
  #         docker manifest push ${BASE_IMG}:${TAG}
          
  #         # 2. (Opcjonalnie) Aktualizujemy tag 'latest'
  #         # ≈ªeby≈õ m√≥g≈Ç robiƒá `docker pull ...:latest` jak leniwa bu≈Ça
  #         echo "Aktualizujƒô latest..."
  #         docker manifest create --amend ${BASE_IMG}:latest \
  #           ${BASE_IMG}:${TAG}-amd64 \
  #           ${BASE_IMG}:${TAG}-arm64
            
  #         docker manifest annotate ${BASE_IMG}:latest ${BASE_IMG}:${TAG}-amd64 --os linux --arch amd64
  #         docker manifest annotate ${BASE_IMG}:latest ${BASE_IMG}:${TAG}-arm64 --os linux --arch arm64
          
  #         docker manifest push ${BASE_IMG}:latest
          
  #         echo "‚úÖ Gotowe! Masz dwa tagi:"
  #         echo "   üëâ ${BASE_IMG}:${TAG} (Bezpieczny, konkretny commit)"
  #         echo "   üëâ ${BASE_IMG}:latest (Zawsze najnowszy)"